<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OurBudget Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        .traffic-light { width: 14px; height: 14px; border-radius: 50%; display: inline-block; transition: all 0.3s ease; }
        .bg-success { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .bg-warning { background-color: #eab308; box-shadow: 0 0 8px #eab308; }
        .bg-danger { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .bg-neutral { background-color: #9ca3af; }
        /* Smooth scrolling for mobile */
        .custom-scroll { -webkit-overflow-scrolling: touch; }
        /* Hide scrollbars for clean look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 custom-scroll">

    <header class="bg-white border-b sticky top-0 z-30 shadow-sm px-4 py-3">
        <div class="max-w-5xl mx-auto">
            <div class="flex justify-between items-center mb-3">
                <div>
                    <h1 class="text-xl font-extrabold text-indigo-700 tracking-tight">OurBudget</h1>
                    <p id="lastUpdated" class="text-[10px] text-gray-400 uppercase tracking-widest font-bold">Syncing...</p>
                </div>
                <div class="flex items-center gap-2 bg-gray-100 px-3 py-1 rounded-full border">
                    <span id="light" class="traffic-light bg-neutral"></span>
                    <span id="statusText" class="text-xs font-bold text-gray-600">Checking Balance</span>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <div class="bg-emerald-50 border border-emerald-100 p-2 rounded-lg">
                    <p class="text-[10px] uppercase text-emerald-700 font-bold">Income (MTD)</p>
                    <p id="mtdIncome" class="text-lg font-bold text-emerald-800">$0</p>
                </div>
                <div class="bg-rose-50 border border-rose-100 p-2 rounded-lg">
                    <p class="text-[10px] uppercase text-rose-700 font-bold">Expenses (MTD)</p>
                    <p id="mtdExpense" class="text-lg font-bold text-rose-800">$0</p>
                </div>
                <div class="bg-slate-50 border border-slate-100 p-2 rounded-lg">
                    <p class="text-[10px] uppercase text-slate-700 font-bold">Net (MTD)</p>
                    <p id="mtdNet" class="text-lg font-bold text-slate-800">$0</p>
                </div>
                <div class="bg-amber-50 border border-amber-100 p-2 rounded-lg">
                    <p class="text-[10px] uppercase text-amber-700 font-bold">Needs Review</p>
                    <p id="reviewBadge" class="text-lg font-bold text-amber-800">0</p>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4 space-y-6">
        
        <section class="bg-white p-4 rounded-xl shadow-sm border grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
                <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Timeframe</label>
                <select id="filterTime" onchange="applyFilters()" class="w-full bg-gray-50 border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="month">This Month</option>
                    <option value="ytd">Year to Date (2026)</option>
                    <option value="6months">Last 6 Months</option>
                    <option value="all">All Records</option>
                </select>
            </div>
            <div>
                <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Category</label>
                <select id="filterCategory" onchange="applyFilters()" class="w-full bg-gray-50 border rounded-lg p-2 text-sm outline-none"></select>
            </div>
            <div>
                <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Card Type</label>
                <select id="filterCard" onchange="applyFilters()" class="w-full bg-gray-50 border rounded-lg p-2 text-sm outline-none"></select>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border">
                <h3 class="text-sm font-bold text-gray-500 mb-4 uppercase tracking-wider">Spending Trends</h3>
                <canvas id="trendChart"></canvas>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border">
                <h3 class="text-sm font-bold text-gray-500 mb-4 uppercase tracking-wider">Top Categories</h3>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <section class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <div class="px-4 py-3 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="text-sm font-bold uppercase text-gray-500">Transaction History</h3>
                <span id="recordCount" class="text-[10px] font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded">0 items</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="text-[10px] uppercase text-gray-400 border-b">
                            <th class="px-4 py-2">Date</th>
                            <th class="px-4 py-2">Payee / Category</th>
                            <th class="px-4 py-2 text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTable" class="divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSO3dh28NbiDkFF4jTtjolPCg4oB3spD4fxw9jYOQiOFphOXOuMCpmsynBempzNXHor52pL_ZtanSz7/pub?gid=1564593237&single=true&output=csv';
        
        let rawData = [];
        let filteredData = [];
        let charts = {};

        // INITIALIZATION
        window.onload = async () => {
            await loadData();
            initFilters();
            applyFilters();
        };

        async function loadData() {
            try {
                const response = await fetch(CSV_URL);
                const data = await response.text();
                
                return new Promise(resolve => {
                    Papa.parse(data, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            // CLEANING: Fix currency strings and dates
                            rawData = results.data.map(row => ({
                                ...row,
                                Transaction_Amount: cleanCurrency(row.Transaction_Amount),
                                Transaction_Date: new Date(row.Transaction_Date),
                                Needs_Review: row.Needs_Review?.toString().toLowerCase() === 'true'
                            })).filter(row => !isNaN(row.Transaction_Amount));
                            
                            document.getElementById('lastUpdated').innerText = `Last Updated: ${new Date().toLocaleTimeString()}`;
                            resolve();
                        }
                    });
                });
            } catch (e) {
                alert("Failed to load budget data. Ensure Sheet is 'Published to Web' as CSV.");
            }
        }

        function cleanCurrency(val) {
            if (typeof val !== 'string') return val;
            return parseFloat(val.replace(/[^0-9.-]+/g, ""));
        }

        function initFilters() {
            const cards = [...new Set(rawData.map(r => r.Card_Type))].filter(Boolean).sort();
            const cats = [...new Set(rawData.map(r => r.Category))].filter(Boolean).sort();
            
            const cardSelect = document.getElementById('filterCard');
            const catSelect = document.getElementById('filterCategory');

            cardSelect.innerHTML = '<option value="all">All Cards</option>' + cards.map(c => `<option value="${c}">${c}</option>`).join('');
            catSelect.innerHTML = '<option value="all">All Categories</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function applyFilters() {
            const timeVal = document.getElementById('filterTime').value;
            const catVal = document.getElementById('filterCategory').value;
            const cardVal = document.getElementById('filterCard').value;
            const now = new Date();

            filteredData = rawData.filter(r => {
                const d = r.Transaction_Date;
                let timeMatch = true;
                
                if (timeVal === 'month') timeMatch = d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                if (timeVal === 'ytd') timeMatch = d.getFullYear() === now.getFullYear();
                if (timeVal === '6months') {
                    const cutoff = new Date();
                    cutoff.setMonth(now.getMonth() - 6);
                    timeMatch = d >= cutoff;
                }

                const catMatch = catVal === 'all' || r.Category === catVal;
                const cardMatch = cardVal === 'all' || r.Card_Type === cardVal;

                return timeMatch && catMatch && cardMatch;
            });

            // Sort newest first
            filteredData.sort((a,b) => b.Transaction_Date - a.Transaction_Date);
            updateUI();
        }

        function updateUI() {
            // 1. Executive Summary logic
            const income = filteredData.filter(r => r.Transaction_Type === 'Income').reduce((s, r) => s + r.Transaction_Amount, 0);
            const expense = filteredData.filter(r => r.Transaction_Type === 'Expense').reduce((s, r) => s + r.Transaction_Amount, 0);
            const reviewCount = filteredData.filter(r => r.Needs_Review).length;

            document.getElementById('mtdIncome').innerText = `$${income.toLocaleString(undefined, {minimumFractionDigits: 0})}`;
            document.getElementById('mtdExpense').innerText = `$${expense.toLocaleString(undefined, {minimumFractionDigits: 0})}`;
            document.getElementById('mtdNet').innerText = `$${(income - expense).toLocaleString()}`;
            document.getElementById('reviewBadge').innerText = reviewCount;
            document.getElementById('recordCount').innerText = `${filteredData.length} Items`;

            // Traffic Light
            const light = document.getElementById('light');
            const statusText = document.getElementById('statusText');
            if (income > expense) {
                light.className = 'traffic-light bg-success';
                statusText.innerText = "Under Budget";
            } else if (expense > income && income > 0) {
                light.className = 'traffic-light bg-danger';
                statusText.innerText = "Over Budget";
            } else {
                light.className = 'traffic-light bg-warning';
                statusText.innerText = "No Income Data";
            }

            // 2. Render Table
            const tbody = document.getElementById('transactionTable');
            tbody.innerHTML = filteredData.slice(0, 50).map(r => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-4 py-3 text-[11px] text-gray-400 font-mono">
                        ${r.Transaction_Date.toLocaleDateString('en-US', {month:'short', day:'numeric'})}
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-bold text-gray-800 truncate w-32 md:w-full">${r.Payee}</div>
                        <div class="text-[10px] text-gray-400 uppercase font-bold">${r.Category}</div>
                    </td>
                    <td class="px-4 py-3 text-right font-black ${r.Transaction_Type === 'Income' ? 'text-emerald-600' : 'text-slate-900'}">
                        ${r.Transaction_Type === 'Income' ? '+' : ''}${r.Transaction_Amount.toFixed(2)}
                    </td>
                </tr>
            `).join('');

            renderCharts(income, expense);
        }

        function renderCharts(incTotal, expTotal) {
            if (charts.cat) charts.cat.destroy();
            if (charts.trend) charts.trend.destroy();

            // Doughnut: Category Split (Expenses only)
            const catData = {};
            filteredData.filter(r => r.Transaction_Type === 'Expense').forEach(r => {
                catData[r.Category] = (catData[r.Category] || 0) + r.Transaction_Amount;
            });
            const topCats = Object.entries(catData).sort((a,b) => b[1] - a[1]).slice(0,5);

            charts.cat = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: topCats.map(x => x[0]),
                    datasets: [{
                        data: topCats.map(x => x[1]),
                        backgroundColor: ['#4f46e5', '#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    cutout: '70%',
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } }
                }
            });

            // Bar: Income vs Expense Comparison
            charts.trend = new Chart(document.getElementById('trendChart'), {
                type: 'bar',
                data: {
                    labels: ['MTD Comparison'],
                    datasets: [
                        { label: 'Income', data: [incTotal], backgroundColor: '#10b981' },
                        { label: 'Expense', data: [expTotal], backgroundColor: '#f43f5e' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { font: { size: 10 } } } }
                }
            });
        }
    </script>
</body>
</html>
